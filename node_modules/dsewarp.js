/*

 GT.M Region DSE Warp List for EWD Lite 2013/07/23 13:12
 
  Written by Kiyoshi Sawada <casiopea.tpine@gmail.com>
  Copyright c 2013 Japan DynaSystems Inc.
 
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License (AGPL)
  as published by the Free Software Foundation, either version 3 of
  the License, or (at your option) any later version.
 
  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.
 
  You should have received a copy of the GNU Affero General Public 
  License along with this program. 
 If not, see http://www.gnu.org/licenses/.
 
*/

module.exports = {

  onSocketMessage: function(ewd) {

    var wsMsg = ewd.webSocketMessage;
    var type = wsMsg.type;
    var params = wsMsg.params;
    var sessid = ewd.session.$('ewd_sessid')._value;
    
    // Ligin Check
    if (type === 'EWD.form.login') {
      //console.log('login: ' + JSON.stringify(params));
      if (params.password === '') return 'You must enter a password';
      if (params.password !== ewd.session.$('ewd_password')._value) return 'Invalid password';
      ewd.session.setAuthenticated();
      return '';
    } 
    
    if (!ewd.session.isAuthenticated) return;

    // Get GT.M Region List
    if (type === 'getRegionList') {
      var regionList = JSON.parse(ewd.mumps.function('DSEregion^%nodemGTM'));
      ewd.sendWebSocketMsg({
        type: 'getRegionList',
        message: regionList
      });
      return '';
    }

    // Get DSE Warp Data for JSON format
    if (type === 'getDseWarpData') {
      var dsewarp = JSON.parse(ewd.mumps.function('DSEWRAPjson^%nodemGTM'));
      ewd.sendWebSocketMsg({
        type: 'getDseWarpData',
        message: dsewarp
      });
      return '';
    }

  }
};
